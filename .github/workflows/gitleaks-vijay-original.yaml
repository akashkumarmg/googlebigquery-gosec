name: Gitleaks Secret Scan - vijay - original
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # daily at 03:00 UTC

permissions:
  contents: write
  issues: write

jobs:
  gitleaks:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1Ô∏è‚É£ Checkout Repo
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # 2Ô∏è‚É£ Debug Repo Contents
      # -----------------------------
      - name: List repo contents
        run: |
          echo "Scanning repository directory: $(pwd)"
          ls -R

      # -----------------------------
      # 3Ô∏è‚É£ Install Gitleaks
      # -----------------------------
      - name: Install Gitleaks v8.30.0
        run: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.30.0/gitleaks_8.30.0_linux_x64.tar.gz
          mkdir /tmp/gitleaks
          tar -xzf gitleaks_8.30.0_linux_x64.tar.gz -C /tmp/gitleaks
          sudo mv /tmp/gitleaks/gitleaks /usr/local/bin/gitleaks
          gitleaks version

      # -----------------------------
      # 4Ô∏è‚É£ Ensure baseline exists
      # -----------------------------
      - name: Ensure baseline exists
        run: |
          if [ ! -f .gitleaks-baseline.json ]; then
            echo "[]" > .gitleaks-baseline.json
          fi

      # -----------------------------
      # 5Ô∏è‚É£ Run Gitleaks Scan
      # -----------------------------
      - name: Run Gitleaks scan
        run: |
          gitleaks detect \
            --source . \
            --baseline-path .gitleaks-baseline.json \
            --redact \
            --report-format json \
            --report-path gitleaks-report.json \
            --exit-code 0

      # -----------------------------
      # 6Ô∏è‚É£ Compare Findings
      # -----------------------------
      - name: Compare findings with baseline
        id: compare
        run: |
          echo "Comparing findings‚Ä¶"

          jq -r '.[].Fingerprint' .gitleaks-baseline.json | sort > baseline_fp.txt
          jq -r '.[].Fingerprint' gitleaks-report.json | sort > report_fp.txt

          comm -13 baseline_fp.txt report_fp.txt > new_only_fp.txt
          NEW_COUNT=$(wc -l < new_only_fp.txt | tr -d ' ')
          echo "New leaks found: $NEW_COUNT"
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT

          if [ "$NEW_COUNT" -gt 0 ]; then
            FINGERPRINTS=$(jq -R -s -c 'split("\n")[:-1]' new_only_fp.txt)
            jq --argjson fps "$FINGERPRINTS" \
               'map(select(.Fingerprint as $fp | $fps | index($fp)))' \
               gitleaks-report.json > new-findings.json
          else
            echo "[]" > new-findings.json
          fi

      # -----------------------------
      # 7Ô∏è‚É£ Create/Update Issue
      # -----------------------------
      - name: Create or update issue
        if: steps.compare.outputs.new_count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const findings = JSON.parse(fs.readFileSync("new-findings.json","utf8"));
            const sample = findings.slice(0, 5);

            const body = [
              "## ‚ö†Ô∏è New Secrets Detected",
              "",
              `A total of **${findings.length} new secrets** were detected by Gitleaks.`,
              "",
              "### üîç Sample (first 5)",
              ...sample.map(f => `- **${f.RuleID}** in \`${f.File}:${f.StartLine}\``),
              "",
              "Full findings CSV is attached below."
            ].join("\n");

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });

            let issue = issues.find(i => i.title === "New Secrets Detected by Gitleaks");

            if (issue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body
              });
              console.log(`Updated issue #${issue.number}`);
            } else {
              issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "New Secrets Detected by Gitleaks",
                body,
                labels: ["security"]
              });
              console.log(`Created issue #${issue.data.number}`);
            }

      # -----------------------------
      # 8Ô∏è‚É£ Attach CSV to issue
      # -----------------------------
      - name: Attach CSV to issue
        if: steps.compare.outputs.new_count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const findings = JSON.parse(fs.readFileSync("new-findings.json", "utf8"));

            const headers = ["RuleID","File","Line","Secret","Link","Fingerprint"];
            const csv = [
              headers.join(","),
              ...findings.map(f =>
                [
                  f.RuleID,
                  f.File,
                  f.StartLine,
                  f.Secret || "",
                  f.Link || "",
                  f.Fingerprint
                ].map(v => `"${v}"`).join(",")
              )
            ].join("\n");

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            const issue = issues.find(i => i.title === "New Secrets Detected by Gitleaks");
            if (!issue) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `üìÑ **CSV of new findings:**\n\n\`\`\`csv\n${csv}\n\`\`\``
            });

      # -----------------------------
      # 9Ô∏è‚É£ Update baseline (Option B)
      # -----------------------------
      - name: Update baseline
        run: |
          REPORT_SIZE=$(jq length gitleaks-report.json)
          echo "Report size: $REPORT_SIZE"

          if [ "$REPORT_SIZE" -gt 0 ]; then
            echo "Updating baseline with full report..."
            cp gitleaks-report.json .gitleaks-baseline.json
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add .gitleaks-baseline.json
            git commit -m "Update Gitleaks baseline (full report)" || echo "No changes"
            git push || echo "Push failed"
          else
            echo "No secrets in report. Baseline will NOT be updated."
          fi
